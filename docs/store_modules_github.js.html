<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: store/modules/github.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: store/modules/github.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const queryString = require('query-string');
export default {
    namespaced: true,
    state: {
        user: {},
        errors: [],
        loginInProgress: false,
        buildStatusChecks: [],
        lastBuildStatusCheck: null,
        buildStatus: null
    },
    getters: {
        lastError(state) {
            const Es = state.errors.length;
            return Es? state.errors[Es - 1] : null
        },
        login(state) {return state.user.login},
        loginInProgress(state) {return state.loginInProgress},
        code() {return queryString.parse(window.location.search).code},
        token() {return queryString.parse(window.location.search).token}
    },
    mutations: {
        setUser (state, name) {state.user = name},
        setLoginFlag (state, f) {state.loginInProgress = f},
        addBuildStatusCheck(state, check) {state.buildStatusChecks.push(check)},
        removeBuildStatusCheck(state) {
            state.lastBuildStatusCheck = state.buildStatusChecks.shift()
        },
        updateBuildStatus(state, status) {state.buildStatus = status},
        addError (state, e) {state.errors.push(e)}
    },
    actions: {
        logout() {
            const URL = queryString.parseUrl(window.location.href);
            window.location = queryString.stringifyUrl({
                url: URL.url,
                query: {
                    ...URL.query,
                    code: null,
                    token: null,
                    logout: true
                }
            }, {skipNull: true});
        },
        redeemCode(nsContext) {
            if (nsContext.getters.loginInProgress)
                return;
            if (nsContext.getters.code === "")
                return nsContext.commit('addError', "Cannot login with empty code");
            nsContext.commit('setLoginFlag', true);
            return fetch(
                '/.netlify/functions/githubAPI',
                {method: "POST",
                    headers: {
                        "task": "redeemCode",
                        "github-code": nsContext.getters.code
                    }
                }
            )
                .then(r => {
                    if (r.status !== 200)
                        throw new Error(`GitHub login received ${r.statusText} (${r.statusCode})`);
                    return r.json();
                })
                .then(r => {
                    console.log(r)
                    if (!r.access_token)
                        throw new Error(`Response had no token.`);
                    nsContext.dispatch('processToken', r.access_token);
                    nsContext.commit('setLoginFlag', false);
                })
                .catch(e => {
                    console.error(e);
                    nsContext.commit('addError', e);
                    nsContext.commit('setLoginFlag', false);
                    nsContext.dispatch('logout');
                })
        },
        processToken(nsContext, token) {
            const URL = queryString.parseUrl(window.location.href);
            const redirect = queryString.stringifyUrl({
                url: URL.url,
                query: {
                    ...URL.query,
                    code: null,
                    token: token,
                    logout: false
                }
            }, {skipNull: true});
            window.location = redirect;
        },
        getUserDetails(nsContext) {
            nsContext.commit('setLoginFlag', true);
            return fetch('/.netlify/functions/githubAPI', {
                method: "POST",
                headers: {task: "getUserDetails"},
                body: JSON.stringify({token: nsContext.getters.token})
            })
                .then(r => {
                    if (r.status !== 200) {
                        throw new Error(`Could not retrieve user details, logging out.`);
                    }
                    return r.json();
                })
                .then(user => nsContext.commit('setUser', user))
                .then(() => nsContext.commit('setLoginFlag', false))
                .then(() => nsContext.dispatch('workshop/findRepositories',
                    {owner: nsContext.getters.login}, {root: true}))
                .catch(e => {
                    console.error(e);
                    nsContext.commit('addError', e);
                    nsContext.commit('setLoginFlag', false);
                    nsContext.dispatch('logout');
                })
        },
        /**
         * Add a new build status check to the end of
         * @param nsContext
         * @param [delay=180000] {number} milliseconds to delay request. Default 3 minutes
         */
        registerBuildCheck(nsContext, {delay=180000}) {
            let lastCheck = null;
            if(nsContext.state.buildStatusChecks.length)
                lastCheck = nsContext.state.buildStatusChecks[nsContext.state.buildStatusChecks.length - 1];
            // If there's already a check scheduled for beyond the target time, don't add another
            if(lastCheck &amp;&amp; lastCheck > performance.now() + delay)
                return;

            // Set the check time to five minutes after the latest check
            const time = (lastCheck? lastCheck : performance.now()) + delay;
            nsContext.commit('addBuildStatusCheck', time);
            // Set the timeout
            return setTimeout(() => nsContext.dispatch('getBuildStatus'), time - performance.now());
        },
        /**
         * Fetch the latest build status for the workshop website
         * @param nsContext
         */
        getBuildStatus(nsContext) {
            nsContext.commit('removeBuildStatusCheck');
            return fetch('/.netlify/functions/githubAPI', {
                method: "POST",
                headers: {task: "getLastBuild"},
                body: JSON.stringify({
                    url: nsContext.rootGetters['workshop/Repository']().url,
                    token: nsContext.getters.token
                })
            })
                .then(r => {
                    if(r.status !== 200)
                        throw new Error(`getBuildStatus received ${r.statusText} (${r.status})`)
                    return r.json();
                })
                .then(status => nsContext.commit('updateBuildStatus', status))
                .catch(e => nsContext.commit('addError', e))
        }
    }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-CustomiseItem.computed.Fields.html">Fields</a></li><li><a href="module-WorkshopProperties.computed.Fields.html">Fields</a></li><li><a href="store.html">store</a></li><li><a href="template.html">template</a></li><li><a href="workshop.html">workshop</a></li></ul><h3>Global</h3><ul><li><a href="global.html#checkResponseCode">checkResponseCode</a></li><li><a href="global.html#copyFile">copyFile</a></li><li><a href="global.html#createRepository">createRepository</a></li><li><a href="global.html#deleteFile">deleteFile</a></li><li><a href="global.html#findRepositories">findRepositories</a></li><li><a href="global.html#findRepositoryFiles">findRepositoryFiles</a></li><li><a href="global.html#getLastBuild">getLastBuild</a></li><li><a href="global.html#getRepoIntroFile">getRepoIntroFile</a></li><li><a href="global.html#getTopics">getTopics</a></li><li><a href="global.html#getUserDetails">getUserDetails</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#OK">OK</a></li><li><a href="global.html#onConfirm">onConfirm</a></li><li><a href="global.html#parseYAML">parseYAML</a></li><li><a href="global.html#pullItem">pullItem</a></li><li><a href="global.html#pushFile">pushFile</a></li><li><a href="global.html#redeemCode">redeemCode</a></li><li><a href="global.html#setTopics">setTopics</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Fri Dec 03 2021 18:21:22 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
