<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/MakeSchedule.vue</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/MakeSchedule.vue</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;template>
  &lt;section>
    &lt;section class="card" v-if="!mainRepo">
      &lt;div class="card-content">
        &lt;p>No workshop detected.&lt;/p>
        &lt;b-button label="Go to create workshop section"
                  icon-left="arrow-left"
                  type="is-warning"
                  @click="$emit('goToCreateWorkshop')"
        />
      &lt;/div>
    &lt;/section>
    &lt;section v-else>
      &lt;section class="card" v-if="mainRepo.extraFiles &amp;&amp; (mainRepo.extraFiles.intro || mainRepo.extraFiles.optional_intro_sections.length || mainRepo.extraFiles.setup_files.length)">
        &lt;header class="card-header">
          &lt;b-tooltip position="is-right" label="Special files are non-lesson files which you can edit. These include things like instructor notes and introductory information.">
            &lt;h1 class="card-header-title">Special files&lt;/h1>
          &lt;/b-tooltip>
        &lt;/header>
        &lt;div class="special-files content">
          &lt;CustomiseItem v-if="mainRepo.extraFiles.intro"
                         :item="mainRepo.extraFiles.intro"
                         override-name="Workshop Intro"
                         override-link="/"
                         :no-y-a-m-l="true"
                         :add-buttons="['save']"
                         :remove-buttons="['drop', 'properties']"
          />
          &lt;CustomiseItem v-for="s in mainRepo.extraFiles.optional_intro_sections"
                         :key="s.url"
                         :item="s"
                         :override-name="`Intro: ${/\/([^/.]+)\.md$/.exec(s.path)[1]}`"
                         override-link="/"
                         :no-y-a-m-l="true"
                         :add-buttons="['save']"
                         :remove-buttons="['drop', 'properties']"
          />
          &lt;CustomiseItem v-for="s in mainRepo.extraFiles.setup_files"
                         :key="s.url"
                         :item="s"
                         :override-name="`Setup: ${/\/([^/.]+)\.html$/.exec(s.path)[1]}`"
                         override-link="/"
                         :no-y-a-m-l="true"
                         :add-buttons="['save']"
                         :remove-buttons="['drop', 'properties']"
          />
          &lt;CustomiseItem v-if="mainRepo.extraFiles.notes"
                         :item="mainRepo.extraFiles.notes"
                         override-name="Instructor Notes"
                         override-link="/notes"
                         :add-buttons="['save', 'edit']"
                         :remove-buttons="['drop', 'properties']"
          />
        &lt;/div>
      &lt;/section>
      &lt;div class="content"
           v-if="schedule.days.length === 1 &amp;&amp; schedule.days[0].items.length === 0"
      >
        &lt;p>There are currently no lessons in the workshop. To add lessons, drag them from the stash into a day. You can search for episodes that have already been created and add them to your stash.&lt;/p>
      &lt;/div>
      &lt;div class="columns">
        &lt;div class="column">
          &lt;div class="card"
               v-for="day in schedule.days"
               :key="day.number"
          >
            &lt;header class="card-header" v-if="!mainRepo.busyFlag()">
              &lt;h1 class="card-header-title">Day {{ day.number }}&lt;/h1>
            &lt;/header>
            &lt;b-skeleton size="is-large" animated :active="mainRepo.busyFlag()"/>
            &lt;div class="card-content" v-if="!mainRepo.busyFlag()">
              &lt;ArrangeItems :items="day.items"
                            :dayId="day.number"
                            @assignItem="updateItemDay"
              />
            &lt;/div>
            &lt;b-skeleton size="is-medium" animated :active="mainRepo.busyFlag()"/>
          &lt;/div>
        &lt;/div>
        &lt;div class="column">
          &lt;div class="card">
            &lt;header class="card-header" v-if="!mainRepo.busyFlag()">
              &lt;h1 class="card-header-title">Stash&lt;/h1>
            &lt;/header>
            &lt;b-skeleton size="is-large" animated :active="mainRepo.busyFlag()"/>
            &lt;div class="card-content" v-if="!mainRepo.busyFlag()">
              &lt;ArrangeItems :items="schedule.unassignedItems"
                            @assignItem="updateItemDay"
                            class="unassigned-items"
              />
            &lt;/div>
            &lt;b-skeleton size="is-medium" animated :active="mainRepo.busyFlag()"/>
            &lt;div class="stash-buttons card-footer-item">
              &lt;b-button class="card-footer-item"
                        icon-left="plus"
                        :type="`is-primary ${allItems.length > 1? 'is-light' : ''}`"
                        @click="addRemoteItems = true"
              >
                Add Items to Stash
              &lt;/b-button>
              &lt;b-button v-if="availableEpisodes.filter(f => !f.yaml.day).length"
                        class="card-footer-item"
                        icon-left="delete"
                        type="is-warning"
                        @click="clearStash"
              >
                Clear stash
              &lt;/b-button>
            &lt;/div>
          &lt;/div>
        &lt;/div>
      &lt;/div>

      &lt;b-modal v-model="addRemoteItems" full-screen>
        &lt;div class="content fullscreen-modal">
          &lt;header class="title">
            &lt;h1 class="">Add items from a different workshop&lt;/h1>
          &lt;/header>
          &lt;div class="content">
            &lt;p>Type the URL, owner, or title of a workshop below, or type a topic name. We will scan workshops that match for lessons and you can then include them in your
              stash. You can then drag them into your schedule and install them (and any files they depend on)
              in your own workshop.&lt;/p>
          &lt;/div>
          &lt;b-autocomplete
                  v-model="remoteRepositoryName"
                  :data="autoCompleteOptions"
                  placeholder="Start typing an owner, workshop URL or title, or tag to filter"
                  icon="magnify"
                  clearable
                  expanded
          >
            &lt;template #empty>No results found&lt;/template>
          &lt;/b-autocomplete>
          &lt;div class="content cards">
            &lt;RemoteRepositoryView v-for="repo in filteredTopicRepositories"
                                  :key="repo.url"
                                  :repo="repo"
                                  @selectRepo="addRepositoryEpisodes"
                                  :is-open="expandedRepo === repo.url"
                                  @open="url => expandedRepo = url"
            />
          &lt;/div>
        &lt;/div>
      &lt;/b-modal>
    &lt;/section>
  &lt;/section>
&lt;/template>

&lt;script>
  import ArrangeItems from "./ArrangeItems";
  import RemoteRepositoryView from "./RemoteRepositoryView";
  import CustomiseItem
    from "./CustomiseItem";
  export default {
    name: 'MakeSchedule',
    components: {
      CustomiseItem,
      RemoteRepositoryView,
      ArrangeItems
    },
    props: {recalculateItems: {type: Boolean, required: false, default: true}},
    data: function() {
      return {
        addRemoteItems: false,
        remoteRepositoryName: "",
        availableEpisodes: [],
        expandedRepo: ""
      }
    },
    computed: {
      mainRepo() {
        let repo;
        try {
          repo = this.$store.getters['workshop/Repository']();
        }
        catch(e) {throw new Error(`Error retrieving Repository from store: ${e}`)}
        return repo;
      },
      /**
       * Return all the episodes in a Repository which has a matching topic.
       */
      allItems() {
        const T = performance.now()
        if(!this.recalculateItems || !this.mainRepo.topics || !this.mainRepo.topics.length)
          return [];
        // Always include main repository episodes
        const episodes = [...this.mainRepo.episodes];
        const mainEpisodes = this.mainRepo.episodes.map(e => e.url);
        // Find repositories that overlap topics with mainRepo
        const topics = this.mainRepo.topics
                .filter(t => this.$store.state.topicList.includes(t));
        const topicRepos = this.$store.getters['workshop/RepositoriesByFilter'](r => {
          for(let t of topics)
            if(r.topics.includes(t))
              return true;
        });
        // Find available, non-duplicate episodes for inclusion
        topicRepos.forEach(R => episodes.push(...R.episodes.filter(
          E => {
            return this.availableEpisodes.filter(e => e.url === E.url).length &amp;&amp;
                    ((E.yaml.ukrn_wb_rules &amp;&amp;
                            E.yaml.ukrn_wb_rules.includes('allow-multiple')) ||
                    episodes.filter(x => E.body === x.body).length === 0)
        })));
        // Add remote flag
        console.log(`Found ${episodes.length} episodes in ${topicRepos.length} repositories in ${Math.round(performance.now() - T)}ms`)
        return episodes.map(e => {return {...e, remote: !mainEpisodes.includes(e.url)}});
      },
      // The schedule is a representation of the episodes in a workshop arranged by day and time
      schedule: function() {
        const T = performance.now()
        const schedule = {days: [], unassignedItems: []};
        this.allItems.forEach(item => {
          // Items without valid day/start_time inputs are unassigned
          if(!item.yaml.day || item.yaml.start_time)
            return schedule.unassignedItems.push(item);
          const dayList = schedule.days.filter(d => d.number === item.yaml.day);
          // create a new day for this item
          if(!dayList.length)
            schedule.days.push({number: item.yaml.day, items: [item]});
          else
            dayList[0].items.push(item);
        });
        // Pad schedule days and add an extra one at the end
        let lastDay = Math.max(...schedule.days.map(d => d.number));
        if(isNaN(lastDay) || lastDay &lt; 0)
          lastDay = 0;
        for(let d = 1; d &lt;= lastDay + 1; d++)
          if(!schedule.days.filter(day => day.number === d).length)
            schedule.days.push({number: d, items: []});
        // Arrange days and items
        schedule.days.sort((a,b) => a.number &lt; b.number? -1 : 1);
        schedule.days.forEach(d => d.items.sort((a, b) => a.yaml.order > b.yaml.order? 1 : -1));
        console.log(`Generated schedule in ${Math.round(performance.now() - T)}ms`)
        return schedule;
      },
      filteredTopicRepositories() {
        return this.$store.getters['workshop/RepositoriesByFilter'](
                // exclude main repo
                r => !r.isMain &amp;&amp;
                        // match filter
                        `${r.ownerLogin}|${r.name}|${r.topics.join('|')}`
                        .toLowerCase()
                        .indexOf(this.remoteRepositoryName.toLowerCase()) >= 0 &amp;&amp;
                        // match topics
                        r.topics.filter(
                                t => this.mainRepo.topics.includes(t) &amp;&amp;
                                        this.$store.state.topicList.includes(t)
                        ).length
        )
      },
      autoCompleteOptions() {
        const options = [];
        this.filteredTopicRepositories.forEach(r => {
          const entries = [r.name, r.ownerLogin, ...r.topics];
          entries.forEach(e => {
            if(!options.includes(e))
              options.push(e);
          })
        });
        return options;
      },
      remoteRepositoryEpisodes() {
        if(!this.remoteRepositoryName)
          return [];
        return this.$store.getters['workshop/RepositoriesByFilter'](
                r => r.name === this.remoteRepositoryName
        )[0].episodes;
      }
    },
    methods: {
      /**
       * Clear stash episodes
       */
      clearStash() {
        this.availableEpisodes = this.availableEpisodes.filter(f => f.yaml.day);
      },
      /**
       * Mark an episode as available for including in the current project
       */
      setEpisodeAvailable(E, available) {
        if(this.availableEpisodes.filter(e => e.url === E.url).length > 0 === available)
          return;
        if(available)
          this.availableEpisodes.push(E);
        else
          this.availableEpisodes = this.availableEpisodes.filter(e => e.url !== E.url)
      },
      updateEpisode(episode) {
        this.$store.dispatch('workshop/setFileContentFromYAML', {
          url: episode.url, yaml: episode.yaml, body: episode.body
        })
      },
      /**
       * Update the scheduled day for an item
       * @param item {object} item to update
       * @param dayId {number|""} day to set
       */
      async updateItemDay({item, dayId, prevOrder, nextOrder}) {
        console.log(`${item.path} DAY => ${dayId} [${prevOrder}, ${nextOrder}]`)
        // Duplicate allow-multiple items
        if(item.yaml['ukrn_wb_rules']
                &amp;&amp; item.yaml['ukrn_wb_rules'].includes('allow-multiple')
                &amp;&amp; dayId !== ""
                &amp;&amp; !item.yaml.day) {
          const remote = item.remote;
          item = await this.$store.dispatch('workshop/duplicateFile', {url: item.url});
          if(remote &amp;&amp; !this.availableEpisodes.filter(e => e.url === item.url).length)
            this.availableEpisodes.push(item);
        } else if(item.yaml['ukrn_wb_rules']
                &amp;&amp; item.yaml['ukrn_wb_rules'].includes('remove-on-stash')
                &amp;&amp; !dayId) {
          this.$store.commit('workshop/removeItem', {array: 'files', item});
          return;
        }

        const newYAML = {...item.yaml};
        newYAML.day = dayId;
        // Place in the correct order
        if(prevOrder &amp;&amp; nextOrder &amp;&amp; prevOrder === nextOrder) {
          // Recalculate item order values if there is no gap.
          // Item will place itself out of order, but since this really rarely happens
          // we're not going to fix it now.
          await this.$store.dispatch('workshop/rewriteEpisodeOrders', {
            dayId, ignore_episodes: [item.url]
          });
        } else if(!prevOrder &amp;&amp; nextOrder)
          newYAML.order = Math.round(nextOrder / 2);
        else if(prevOrder &amp;&amp; !nextOrder)
          newYAML.order = Math.round(prevOrder + 100000);
        else if(prevOrder &amp;&amp; nextOrder)
          newYAML.order = Math.round(prevOrder + (nextOrder - prevOrder) / 2);
        else
          newYAML.order = 100000;
        this.updateEpisode({...item, yaml: newYAML});
      },
      addRepositoryEpisodes(episodes) {
        // Close modal
        this.addRemoteItems = false;
        episodes.forEach(E => this.setEpisodeAvailable(E, true));
      }
    },
    mounted() {}
  }
&lt;/script>

&lt;!-- Add "scoped" attribute to limit CSS to this component only -->
&lt;style lang="scss" scoped>
  .card {margin-bottom: 1em;}
  .cards {
    width: 100%;
  }
  .fullscreen-modal > * {padding: 1em;}
  .unassigned-items {
  }
  .special-files.special-files {
    display: flex;
    flex-wrap: wrap;
    padding: 1em;
    margin-bottom: 0;
    user-select: none;
    .item-wrapper {padding: .5em;}
  }
  .stash-buttons {
    button {
      margin: .5em;
    }
  }
&lt;/style>
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-CustomiseItem.computed.Fields.html">Fields</a></li><li><a href="module-WorkshopProperties.computed.Fields.html">Fields</a></li><li><a href="store.html">store</a></li><li><a href="template.html">template</a></li><li><a href="workshop.html">workshop</a></li></ul><h3>Global</h3><ul><li><a href="global.html#checkResponseCode">checkResponseCode</a></li><li><a href="global.html#copyFile">copyFile</a></li><li><a href="global.html#createRepository">createRepository</a></li><li><a href="global.html#deleteFile">deleteFile</a></li><li><a href="global.html#findRepositories">findRepositories</a></li><li><a href="global.html#findRepositoryFiles">findRepositoryFiles</a></li><li><a href="global.html#getLastBuild">getLastBuild</a></li><li><a href="global.html#getRepoIntroFile">getRepoIntroFile</a></li><li><a href="global.html#getTopics">getTopics</a></li><li><a href="global.html#getUserDetails">getUserDetails</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#OK">OK</a></li><li><a href="global.html#onConfirm">onConfirm</a></li><li><a href="global.html#parseYAML">parseYAML</a></li><li><a href="global.html#pullItem">pullItem</a></li><li><a href="global.html#pushFile">pushFile</a></li><li><a href="global.html#redeemCode">redeemCode</a></li><li><a href="global.html#setTopics">setTopics</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Fri Dec 03 2021 18:21:22 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
